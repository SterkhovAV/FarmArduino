#include <GyverTimer.h>            // Удобная библиотека времени https://alexgyver.ru/gyvertimer/
#include <Wire.h>                  // Устанавливаем дисплей
#include <LiquidCrystal_I2C.h>     // Устанавливаем дисплей

LiquidCrystal_I2C lcd(0x27,16,2);  // Устанавливаем дисплей
GTimer LightON (MS,3000000); // время которое горит лампа 3000000=50 мин
GTimer LightOFF (MS,600000); // пауза 600000=10 мин
GTimer hours24 (MS,86400000); //полный период ( период паузы = LigthOFF-LightON; пауза следует за периодом свечения) 86400000=24ч
GTimer HumidityTime (MS,900000); // опрос влажности

int Humidity;
int Potentiometer;
int LightTimes=0;

void setup() {
  
  pinMode(2,OUTPUT);  //Управление насосом
  pinMode(3,OUTPUT);  //Управление фитолампой
  pinMode(A1,INPUT);  //Датчик влажности
  pinMode(A2,INPUT_PULLUP);  //Уставка влажности (потенциометр)
  pinMode(A3,INPUT);  //Датчик уровня (защита насоса)
  analogReference(DEFAULT);
  
  lcd.init(); // Инициализация дисплея                    
  lcd.backlight(); // Включаем подсветку дисплея
  
  light(true); // первичное включение света

  Humidity=humidityINIT();
  Potentiometer=potentiometer();
  
  //Serial.begin(9600); // - вывод в консоль. ОТЛАДОЧНАЯ ФУНКЦИЯ
  
  }

void loop() {
  if (LightON.isReady()) {
    LightTimes=LightTimes+1;
    light(false);
    LightON.stop();
    LightOFF.start();
  }
  
  if (LightOFF.isReady()&&LightTimes<8) {
    light(true);
    LightOFF.stop();
    LightON.start();
  }
  
  if (hours24.isReady()) {
    light(true);
    LightTimes=0;
    LightON.start();
    
  }
  if (HumidityTime.isReady()) {
    HumidityTime.start();
    Humidity=humidity();
    Potentiometer=potentiometer();
    if (Humidity<Potentiometer) {
      if (midArifm()>4.95)
       pump();
    }
  }                                  

  Display(potentiometer(),Humidity); 
   //Serial.println(Humidity); // - вывод в консоль. ОТЛАДОЧНАЯ ФУНКЦИЯ
  
}

void pump() {
  digitalWrite(2, HIGH);
  delay (15000);
  digitalWrite(2, LOW);
  
}


float midArifm() {   //   Фильтр датчика защиты насоса
  float sum = 0;                    
  for (int i = 0; i < 100; i++){  
    sum += (float)(analogRead(A3) * 5.0) / 1025;}
    delay(5000);
    return (sum / 100);
}

int humidity() {      //ЧТЕНИЕ ДАТЧИКА ВЛАЖНОСТИ
  float humidityVoltage = (float)(analogRead(A1) * 5.0) / 1025;  // получаем текущее значение
  int humidityValue = constrain(map(humidityVoltage*100, 300, 200, 0, 100), 0, 99); ; //приведение к %
  delay(1);        // небольшая задержка для стабильности вывода результатов
  return humidityValue;}

int humidityINIT() {
  delay (3000);
  int Humidity=humidity();
  return Humidity;
}

int potentiometer(){  //ЧТЕНИЕ ПОТЕНЦИОМЕТРА
  float potentiometerVoltage = (float)(analogRead(A2) * 5.0) / 1025;  // получаем текущее значение
  int potentiometerValue = constrain(map(potentiometerVoltage*100, 14, 500, 0, 100), 0, 99); ; //приведение к %
  delay(1);        // небольшая задержка для стабильности вывода результатов
  return potentiometerValue;}

void Display(int Value1,int Value2){
  
  lcd.setCursor(0, 0);                //Блок вывода уставки влажности
  lcd.print("Humidity set:");
  if (Value1>=10) {
    lcd.setCursor(13, 0);
    lcd.print(Value1);}
  if (Value1<10) {
    lcd.print(" ");
    lcd.setCursor(14, 0);
    lcd.print(Value1);}
  lcd.setCursor(15, 0);
  lcd.print("%");

  lcd.setCursor(0, 1);                //Блок вывода значения влажности почвы
  lcd.print("Humid. soil:");
  if (Value1>=10) {
    lcd.setCursor(13, 1);
    lcd.print(Value2);}
  if (Value2<10) {
    lcd.print(" ");
    lcd.setCursor(14, 1);
    lcd.print(Value2);}
  lcd.setCursor(15, 1);
  lcd.print("%");}


void light(boolean state)  { 
  if (state)digitalWrite(3, HIGH);
  else digitalWrite(3, LOW);}
